# Kong Configuration for Production Hardening
# Based on Konnect Go-Live Hardening & Readiness Checklist

# ==============================================================================
# GENERAL
# ==============================================================================

# Platform identification
prefix = /usr/local/kong/

# ==============================================================================
# NGINX
# ==============================================================================

# worker processes
nginx_worker_processes = 2

# ==============================================================================
# DEVELOPMENT & MISCELLANEOUS
# ==============================================================================

# SECURITY: Disable debug header in production
allow_debug_header = off

# SECURITY: Disable server headers for fingerprinting protection
headers = off

# SECURITY: Disable untrusted Lua execution unless leveraging post or pre-function plugins
untrusted_lua = off # or sandbox (default)

# SECURITY: Anonymous reports (disable for security)
anonymous_reports = off

# ==============================================================================
# NGINX INJECTIONS
# ==============================================================================

# Proxy listen addresses - HTTPS only for production
# proxy_listen = 0.0.0.0:8443 ssl http2

# Real IP handling for load balancer scenarios
# Configure based on your load balancer CIDR ranges
# trusted_ips = 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
real_ip_header = X-Forwarded-For
real_ip_recursive = on

# SECURITY: Disable HTTP access logs (use Kong logs instead)
proxy_access_log = off

# Proxy error logs
proxy_error_log = /dev/stderr
log_level = notice

# ==============================================================================
# SSL/TLS CONFIGURATION
# ==============================================================================

# SSL configuration (set certificate paths via environment variables)
# ssl_cert = /etc/kong/ssl/kong.crt
# ssl_cert_key = /etc/kong/ssl/kong.key

# SSL protocols and ciphers for security
ssl_protocols = TLSv1.2 TLSv1.3
# ssl_ciphers = ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
ssl_prefer_server_ciphers = on

# Always verify upstream TLS certificates
# This is crucial especially when Kong is acting as an egress proxy
nginx_proxy_proxy_ssl_verify = on
nginx_proxy_proxy_ssl_trusted_certificate = /etc/ssl/certs/rootCA.crt
nginx_proxy_proxy_ssl_verify_depth = 3

# HSTS for security
# Comma-separated list of headers Kong should inject in requests to upstream.
# At this time, the only accepted values are: 
# - X-Kong-Request-Id: Unique identifier of the request.
# - off, which prevents Kong from injecting the above header. Note that this does not prevent plugins from injecting headers of their own.
# headers_upstream = off

# ==============================================================================
# PERFORMANCE & LIMITS
# ==============================================================================

# Request limits for security
# For most APIs and web services (recommended)
nginx_http_client_max_body_size = 10m

# Alternative values based on use case:
# nginx_http_client_max_body_size = 0    # For no limit
# nginx_http_client_max_body_size = 1m   # For strict APIs with small payloads
# nginx_http_client_max_body_size = 50m  # For file uploads or larger payloads
# nginx_http_client_max_body_size = 100m # For media/document uploads

# Client body buffer size - controls memory allocation for request bodies
nginx_http_client_body_buffer_size = 8k # Default, minimal memory usage

# Alternative values based on your use case:
# nginx_http_client_body_buffer_size = 8k   # Default, minimal memory usage
# nginx_http_client_body_buffer_size = 16k  # Balanced for most APIs
# nginx_http_client_body_buffer_size = 32k - 64k  # For larger request payloads
# nginx_http_client_body_buffer_size = 128k # For file upload scenarios

# Timeout configurations
# upstream_keepalive_pool_size = 512
# upstream_keepalive_max_requests = 10000
# upstream_keepalive_idle_timeout = 60s

# ==============================================================================
# LOGGING
# ==============================================================================

# Error logs
# Default MIME type to use when the request Accept header is missing and Nginx is returning an error for the request.
# Accepted values are text/plain, text/html, application/json, and application/xml.
error_default_type = application/json