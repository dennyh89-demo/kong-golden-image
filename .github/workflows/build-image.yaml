name: Build Kong Golden Image

on:
  # push:
  #   branches: [main]
  # schedule:
  #   # Weekly security updates
  #   - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      kong_version:
        description: 'Kong version to build'
        required: true
        default: '3.10.0.1'
      docker_registry:
        description: 'Docker registry'
        type: string
        default: localhost:5000

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DOCKERFILE_DIR: ${{ github.workspace }}/dockerfiles
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - uses: grafana/setup-k6-action@v1

    - name: Setup Bats and bats libs
      id: setup-bats
      uses: bats-core/bats-action@3.0.0
      
    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.docker_registry }}
        username: ${{ secrets.DOCKER_USERNAME || github.actor}}
        password: ${{ secrets.DOCKER_PASSWORD || secrets.GITHUB_TOKEN }}
        
    - name: Download Kong Gateway
      run: |
        KONG_VERSION="${{ inputs.kong_version }}"
        KONG_MAJOR_MINOR_VERSION=$(echo "$KONG_VERSION" | cut -d. -f1-2 | tr -d '.')
        KONG_PACKAGE_NAME="kong-enterprise-edition_${KONG_VERSION}_amd64.deb"
        KONG_URL="https://packages.konghq.com/public/gateway-${KONG_MAJOR_MINOR_VERSION}/deb/debian/pool/bullseye/main/k/ko/kong-enterprise-edition_${KONG_VERSION}/${KONG_PACKAGE_NAME}"

        echo "Downloading Kong Gateway version: $KONG_VERSION (major version: $KONG_MAJOR_MINOR_VERSION)..."
        echo "Fetching from URL: $KONG_URL"

        curl -s -o kong.deb "$KONG_URL"
      working-directory: ${{ env.DOCKERFILE_DIR }}
        
    # - name: Build image
    #   uses: docker/build-push-action@v5
    #   with:
    #     context: .
    #     file: dockerfiles/Dockerfile.ubuntu
    #     platforms: linux/amd64,linux/arm64
    #     push: false
    #     tags: |
    #       ${{ inputs.docker_registry }}/kong-gateway:${{ github.event.inputs.kong_version || '3.10.0.1' }}
    #       ${{ inputs.docker_registry }}/kong-gateway:latest
    #     cache-from: type=gha
    #     cache-to: type=gha,mode=max
        
    # - name: Run smoke tests
    #   run: |
    #     docker run --rm -d --name kong-test \
    #       your-org-registry.com/kong-gateway:${{ github.event.inputs.kong_version || '3.10.0.1' }}
    #     sleep 30
    #     chmod +x scripts/kong-smoke-tests.bats
    #     ./scripts/kong-smoke-tests.bats
    #     docker stop kong-test
        
    # - name: Run security scan
    #   uses: aquasecurity/trivy-action@master
    #   with:
    #     image-ref: your-org-registry.com/kong-gateway:${{ github.event.inputs.kong_version || '3.10.0.1' }}
    #     format: 'sarif'
    #     output: 'trivy-results.sarif'
        
    # - name: Run load tests
    #   run: |
    #     docker run --rm -d --name kong-load-test \
    #       -p 8000:8000 \
    #       your-org-registry.com/kong-gateway:${{ github.event.inputs.kong_version || '3.10.0.1' }}
    #     sleep 30
    #     npx k6 run tests/load/k6/load.js
    #     docker stop kong-load-test
        
    # - name: Push image
    #   if: success()
    #   uses: docker/build-push-action@v5
    #   with:
    #     context: .
    #     file: dockerfiles/Dockerfile.ubuntu
    #     platforms: linux/amd64,linux/arm64
    #     push: true
    #     tags: |
    #       your-org-registry.com/kong-gateway:${{ github.event.inputs.kong_version || '3.10.0.1' }}
    #       your-org-registry.com/kong-gateway:latest