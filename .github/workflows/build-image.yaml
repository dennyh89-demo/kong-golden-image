name: Build Kong Golden Image

on:
  # push:
  #   branches: [main]
  # schedule:
  #   # Weekly security updates
  #   - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      kong_version:
        description: 'Kong version to build'
        required: true
        default: "3.10.0.2"
      docker_registry:
        description: 'Docker registry'
        type: string
        default: localhost:5000
      org_patch_version:
        description: 'Organization patch version'
        type: string
        default: "1"
      environment:
        description: 'Target environment (dev, staging, prod)'
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev
      continue_on_scan_failure:
        description: 'Continue on Trivy scan failure'
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DOCKERFILE_DIR: ${{ github.workspace }}/dockerfiles
      KONG_VERSION: ${{ inputs.kong_version }}
      ORG_PATCH_VERSION: ${{ inputs.org_patch_version }}
      ENVIRONMENT: ${{ inputs.environment }}
      BUILD_NUMBER: ${{ github.run_number }}
      DOCKER_REGISTRY: ${{ inputs.docker_registry }}
      VAULT_ADDR: http://localhost:8300
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: kong/setup-deck@v1

    - name: Generate semantic tags
      id: tags
      run: |
        # Base semantic version: {KONG_VERSION}-{ORG_PATCH}.{BUILD_NUMBER}
        SEMANTIC_VERSION="${KONG_VERSION}-${ORG_PATCH_VERSION}.${BUILD_NUMBER}"
        
        # Semantic version with environment suffix: {KONG_VERSION}-{ORG_PATCH}.{BUILD_NUMBER}-{ENV}
        SEMANTIC_VERSION_WITH_ENV="${SEMANTIC_VERSION}-${ENVIRONMENT}"
        
        # Extract major.minor version from Kong version (e.g., 3.10.0.2 -> 3.10)
        KONG_MAJOR_MINOR=$(echo "$KONG_VERSION" | cut -d. -f1-2)
        
        # Generate environment-specific tags only
        TAGS=""
        
        # 1. Semantic versioning tag with environment suffix
        TAGS="${TAGS}${DOCKER_REGISTRY}/kong-gateway:${SEMANTIC_VERSION_WITH_ENV},"
        
        # 2. Kong version with environment suffix
        TAGS="${TAGS}${DOCKER_REGISTRY}/kong-gateway:${KONG_VERSION}-${ENVIRONMENT},"
        
        # 3. Major.Minor latest with environment suffix
        TAGS="${TAGS}${DOCKER_REGISTRY}/kong-gateway:${KONG_MAJOR_MINOR}-latest-${ENVIRONMENT},"
        
        # 4. Latest with environment suffix (only for prod environment)
        if [ "$ENVIRONMENT" = "prod" ]; then
          TAGS="${TAGS}${DOCKER_REGISTRY}/kong-gateway:latest-${ENVIRONMENT},"
        fi
        
        # Remove trailing comma
        TAGS=$(echo "$TAGS" | sed 's/,$//')
        
        echo "semantic_version=${SEMANTIC_VERSION}" >> $GITHUB_OUTPUT
        echo "semantic_version_with_env=${SEMANTIC_VERSION_WITH_ENV}" >> $GITHUB_OUTPUT
        echo "kong_major_minor=${KONG_MAJOR_MINOR}" >> $GITHUB_OUTPUT
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        
        # Display tagging strategy
        echo "üè∑Ô∏è Tagging Strategy Applied:"
        echo "Base Semantic Version: ${SEMANTIC_VERSION}"
        echo "Environment-Specific Semantic Version: ${SEMANTIC_VERSION_WITH_ENV}"
        echo "Kong Major.Minor: ${KONG_MAJOR_MINOR}"
        echo "Generated Tags:"
        echo "$TAGS" | tr ',' '\n' | sed 's/^/  - /'
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - uses: grafana/setup-k6-action@v1

    - name: Setup Bats and bats libs
      id: setup-bats
      uses: bats-core/bats-action@3.0.0

    - name: Import CA Certificate
      id: import-secrets
      uses: hashicorp/vault-action@v2
      with:
        url: ${{ env.VAULT_ADDR }}
        token: ${{ secrets.VAULT_TOKEN }}
        secrets: |
          pki/cert/ca certificate | CA_CERT ;

    - name: Save CA Certificate to file
      run: |
        echo "${{ steps.import-secrets.outputs.CA_CERT }}" > certificates/rootCA.crt
      shell: bash

    - name: Fetch Custom Plugin
      run: |
        git clone https://github.com/Kong/kong-plugin.git
      
    - name: Login to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.docker_registry }}
        username: ${{ secrets.DOCKER_USERNAME || github.actor}}
        password: ${{ secrets.DOCKER_PASSWORD || secrets.GITHUB_TOKEN }}
        
    - name: Download Kong Gateway
      run: |
        KONG_VERSION="${{ inputs.kong_version }}"
        KONG_MAJOR_MINOR_VERSION=$(echo "$KONG_VERSION" | cut -d. -f1-2 | tr -d '.')
        KONG_PACKAGE_NAME="kong-enterprise-edition_${KONG_VERSION}_amd64.deb"
        KONG_URL="https://packages.konghq.com/public/gateway-${KONG_MAJOR_MINOR_VERSION}/deb/debian/pool/bullseye/main/k/ko/kong-enterprise-edition_${KONG_VERSION}/${KONG_PACKAGE_NAME}"

        echo "Downloading Kong Gateway version: $KONG_VERSION (major version: $KONG_MAJOR_MINOR_VERSION)..."
        echo "Fetching from URL: $KONG_URL"

        curl -s -o kong.deb "$KONG_URL"
        
    - name: Build image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: dockerfiles/Dockerfile.debian
        platforms: linux/amd64
        push: false
        load: true
        tags: ${{ steps.tags.outputs.tags }}
        build-args: |
          KONG_VERSION=${{ inputs.kong_version }}
          ORG_PATCH_VERSION=${{ inputs.org_patch_version }}
          BUILD_NUMBER=${{ github.run_number }}
          ENVIRONMENT=${{ inputs.environment }}

    # - name: Run Trivy vulnerability scanner
    #   continue-on-error: ${{ inputs.continue_on_scan_failure }}
    #   uses: aquasecurity/trivy-action@0.28.0
    #   with:
    #     image-ref: ${{ inputs.docker_registry }}/kong-gateway:${{ github.event.inputs.kong_version || '3.10.0.1' }}
    #     format: 'table'
    #     output: 'reports/trivy-report.txt'
    #     exit-code: '1'
    #     severity: 'CRITICAL,HIGH'

    # - name: Output Trivy report
    #   run: |
    #     cat reports/trivy-report.txt
    #   if: always()

    - name: Create docker network for smoke tests
      run: |
        docker network create kong-net-${{ github.run_id }}
      continue-on-error: true

    - name: Start PostgreSQL database for testing
      run: |
        echo "üêò Starting PostgreSQL database for Kong Admin API testing..."
        docker run -d --name postgres-db \
        --network kong-net-${{ github.run_id }} \
        -p 5432:5432 \
        --env POSTGRES_USER=kong \
        --env POSTGRES_PASSWORD=kongpass \
        --env POSTGRES_DB=kong \
        --health-cmd "pg_isready -U kong -d kong" \
        --health-interval 10s \
        --health-timeout 5s \
        --health-retries 5 \
        postgres:13-alpine

    - name: Wait for PostgreSQL to be ready
      run: |
        echo "‚è≥ Waiting for PostgreSQL to be ready..."
        timeout 60s sh -c 'until docker ps | grep postgres-db | grep -q healthy; do echo "Waiting for PostgreSQL to be available..."; sleep 2; done'
        echo "‚úÖ PostgreSQL is ready!"

    - name: Run Kong database migrations
      run: |
        echo "üîÑ Running Kong database migrations..."
        docker run --rm \
        --network kong-net-${{ github.run_id }} \
        --env KONG_DATABASE=postgres \
        --env KONG_PG_HOST=postgres-db \
        --env KONG_PG_PORT=5432 \
        --env KONG_PG_USER=kong \
        --env KONG_PG_PASSWORD=kongpass \
        --env KONG_PLUGINS=bundled,myplugin \
        --env KONG_PG_DATABASE=kong \
        ${{ inputs.docker_registry }}/kong-gateway:${{ steps.tags.outputs.semantic_version_with_env }} \
        kong migrations bootstrap
        echo "‚úÖ Kong migrations completed!"

    - name: Run Kong container with PostgreSQL
      run: |
          echo "ü¶ç Starting Kong Gateway with PostgreSQL backend..."
          docker run -d --name kong-gateway \
          --network kong-net-${{ github.run_id }} \
          -p 8000:8000 -p 8001:8001 -p 8100:8100 -p 8443:8443 -p 8444:8444 \
          --env KONG_DATABASE=postgres \
          --env KONG_PG_HOST=postgres-db \
          --env KONG_PG_PORT=5432 \
          --env KONG_LICENSE_DATA='${{ secrets.KONG_LICENSE_DATA }}' \
          --env KONG_PG_USER=kong \
          --env KONG_PG_PASSWORD=kongpass \
          --env KONG_PG_DATABASE=kong \
          --env KONG_ADMIN_LISTEN="0.0.0.0:8001" \
          --env KONG_STATUS_LISTEN=0.0.0.0:8100 \
          --env KONG_PLUGINS=bundled,myplugin \
          --env KONG_NGINX_WORKER_PROCESSES=1 \
          --health-cmd "kong health" \
          --health-interval 10s \
          --health-timeout 5s \
          --health-retries 5 \
          ${{ inputs.docker_registry }}/kong-gateway:${{ steps.tags.outputs.semantic_version_with_env }}

    - name: Wait for Kong Gateway to start
      run: |
        echo "‚è≥ Waiting for Kong Gateway to be healthy..."
        timeout 60s sh -c 'until docker ps | grep kong-gateway | grep -q healthy; do echo "Waiting for Kong Gateway to be available..."; sleep 2; done'
        echo "‚úÖ Kong Gateway is healthy!"
      shell: bash

    - name: Configure Kong with Deck
      run: |
        echo "üîß Configuring Kong Gateway with Deck..."
        deck gateway sync configs/kong.yaml
        echo "‚úÖ Kong configuration applied successfully!"

    - name: Wait until the test route is available
      run: |
        echo "‚è≥ Waiting for Kong routes to be available..."
        timeout 60s sh -c 'until curl -s http://localhost:8000/test | grep -q "OK"; do echo "Waiting for test route..."; sleep 2; done'
        echo "‚úÖ Test route is available!"
        
    - name: Run smoke tests
      run: |
        bats kong-smoke-tests.bats | tee ${{ github.workspace }}/reports/smoke_test_report.log
      working-directory: ${{ github.workspace }}/scripts

    - name: Run Load tests
      uses: grafana/run-k6-action@v1
      env:
        K6_TEST_URL: http://localhost:8000
        K6_ADMIN_URL: http://localhost:8001
      with:
        path: |
          tests/k6/load.js
        flags: --vus 50 --duration 10s
        working-directory: ${{ github.workspace }}

    - name: Stop and remove Docker containers and network
      if: always()
      run: |
        echo "üßπ Cleaning up test environment..."
        # Stop and remove Kong Gateway
        docker stop kong-gateway || true
        docker rm kong-gateway || true
        
        # Stop and remove PostgreSQL
        docker stop postgres-db || true
        docker rm postgres-db || true
        
        # Remove network
        docker network rm kong-net-${{ github.run_id }} || true
        
        echo "‚úÖ Cleanup completed!"

    - name: Push Docker image
      if: success()
      uses: docker/build-push-action@v5
      with:
        context: .
        file: dockerfiles/Dockerfile.debian
        platforms: linux/amd64
        push: true
        tags: ${{ steps.tags.outputs.tags }}
        build-args: |
          KONG_VERSION=${{ inputs.kong_version }}
          ORG_PATCH_VERSION=${{ inputs.org_patch_version }}
          BUILD_NUMBER=${{ github.run_number }}
          ENVIRONMENT=${{ inputs.environment }}

    - name: Inspect
      run: |
        echo "üîç Inspecting pushed images..."
        echo "Environment-specific semantic tag: ${{ inputs.docker_registry }}/kong-gateway:${{ steps.tags.outputs.semantic_version_with_env }}"
        echo "Base semantic tag: ${{ inputs.docker_registry }}/kong-gateway:${{ steps.tags.outputs.semantic_version }}"
        echo ""
        
        # Inspect the environment-specific semantic version tag
        docker buildx imagetools inspect ${{ inputs.docker_registry }}/kong-gateway:${{ steps.tags.outputs.semantic_version_with_env }}

    - name: Build Summary
      if: success()
      run: |
        echo "‚úÖ Kong Golden Image Build Complete!"
        echo "==========================================="
        echo ""
        echo "üì¶ **Build Details:**"
        echo "Kong Version: ${{ inputs.kong_version }}"
        echo "Base Semantic Version: ${{ steps.tags.outputs.semantic_version }}"
        echo "Environment-Specific Semantic Version: ${{ steps.tags.outputs.semantic_version_with_env }}"
        echo "Environment: ${{ inputs.environment }}"
        echo "Registry: ${{ inputs.docker_registry }}"
        echo ""
        echo "üè∑Ô∏è **Tags Created:**"
        echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' | sed 's/^/  ‚úì /'
        echo ""
        echo "üîß **Configuration Applied:**"
        if [ "${{ inputs.environment }}" = "prod" ]; then
          echo "  ‚úì Production hardened kong.conf"
          echo "  ‚úì Security headers disabled"
          echo "  ‚úì Debug headers disabled"
          echo "  ‚úì Untrusted Lua disabled"
          echo "  ‚úì SSL/TLS hardening applied"
        else
          echo "  ‚úì Development/staging configuration"
        fi
        echo ""
        echo "üóÑÔ∏è **Database Integration:**"
        echo "  ‚úì PostgreSQL backend tested"
        echo "  ‚úì Admin API functionality verified"
        echo "  ‚úì Database migrations completed"
        echo "  ‚úì CRUD operations validated"
        echo ""
        echo "üß™ **Tests Completed:**"
        echo "  ‚úì Health checks for all ports (8000, 8001, 8100, 8443)"
        echo "  ‚úì Admin API integration tests"
        echo "  ‚úì Database connectivity tests"
        echo "  ‚úì Smoke tests with BATS"
        echo "  ‚úì Load tests with k6 (Proxy)"
        echo ""
        echo "üöÄ **Usage:**"
        echo "docker pull ${{ inputs.docker_registry }}/kong-gateway:${{ steps.tags.outputs.semantic_version_with_env }}"
        echo ""
        echo "üîó **Admin API:** http://localhost:8001"
        echo "üîó **Proxy API:** http://localhost:8000"
        
    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: reports
        path: reports/*